<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OrderGo - Nhập liệu bán hàng</title>
  <!-- UI style: nhẹ nhàng nền xanh nhạt, khung trắng bo góc -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" />
  <style>
    :root{
      --bg: #eaf6f3; /* xanh nhạt */
      --card: #ffffff;
      --accent: #2f9e8f; /* nút nổi nhưng dịu */
      --muted: #6b7280;
      --radius: 12px;
      --pad: 12px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    body{background:var(--bg); padding:20px;}
    .wrap{max-width:1200px; margin:0 auto;}
    .card{background:var(--card); border-radius:var(--radius); box-shadow:0 8px 30px rgba(23,43,77,0.06); padding:16px; margin-bottom:16px}
    header{display:flex; gap:12px; align-items:center; justify-content:space-between}
    h1{font-size:20px; margin:0}
    .controls{display:flex; gap:8px; align-items:center}

    /* Unified button styles */
    .btn{display:inline-flex; gap:8px; align-items:center; justify-content:center; background:var(--accent); color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600}
    .btn.icon-only{padding:8px; width:40px; height:40px}
    .btn.secondary{background:transparent; color:var(--accent); border:1px solid rgba(47,158,143,0.12); font-weight:600}
    .btn.small{padding:6px 8px; font-size:13px}
    .btn.ghost{background:transparent; color:var(--muted); border:1px solid rgba(0,0,0,0.04)}

    input[type=text], input[type=date], input[type=number], select, textarea{padding:8px; border-radius:8px; border:1px solid #e6eef0; width:100%; box-sizing:border-box}
    .row{display:flex; gap:12px}
    .col{flex:1}
    table{width:100%; border-collapse:collapse}
    th, td{padding:8px; border-bottom:1px solid #f1f6f5; text-align:left; vertical-align:top}
    th{background:transparent; color:var(--muted); font-weight:600}
    small.muted{color:var(--muted)}
    .badge{background:#eef9f7; color:var(--accent); padding:6px 10px; border-radius:999px}
    .notice{font-size:13px; color:#334155}
    .flex{display:flex; gap:10px; align-items:center}
    .icon-btn{background:transparent; border:0; cursor:pointer; padding:6px}
    .right{margin-left:auto}
    .table-actions button{margin-right:6px}
    .wrap-text{white-space:pre-wrap; word-break:break-word}
    .small{font-size:13px}
    .muted{color:var(--muted)}
    .footer-note{font-size:13px; color:#475569}

    /* customer suggestion panel */
    .customers-panel{border-radius:8px; border:1px solid #e6eef0; padding:8px; max-height:220px; overflow:auto; background:#fff}
    .customer-row{padding:8px; border-bottom:1px solid #f3f7f6}
    .customer-row:last-child{border-bottom:none}
    .collapsed{display:none}

    /* responsive */
    @media (max-width:900px){ .row{flex-direction:column} .controls{flex-direction:column; align-items:flex-end} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <div>
          <h1>OrderGo – Nhập liệu bán hàng</h1>
          <div class="notice">Giao diện: nhẹ nhàng, nền xanh nhạt. Host trên GitHub Pages — kết nối Google Sheets qua Web App.</div>
        </div>
        <div class="controls">
          <!-- short create button -->
          <button id="btnNewBatch" class="btn small" title="Tạo mã đơn tổng"><i data-feather="plus-circle"></i><span id="newBatchLabel">Tạo mã</span></button>
          <select id="selBatches" style="min-width:240px"></select>
          <button id="btnSave" class="btn small" title="Lưu local & gửi lên Google Sheets"><i data-feather="save"></i><span id="saveLabel">Lưu</span></button>
          <button class="btn secondary small" id="btnExportExcel"><i data-feather="download"></i> Excel</button>
          <button class="btn secondary small" id="btnExportPDF"><i data-feather="printer"></i> PDF</button>
        </div>
      </header>
    </div>

    <!-- Orders list placed earlier, customer panel moved to bottom per request -->

    <!-- Products -->
    <div class="card" id="cardProducts">
      <h3>Bảng danh sách hàng hóa</h3>
      <div style="margin-bottom:10px" class="row">
        <div style="width:260px"><input type="text" id="prodName" placeholder="Tên hàng" /></div>
        <div style="width:130px"><input type="number" id="prodIn" placeholder="Nhập" min="0" /></div>
        <div style="width:160px"><input type="number" id="prodPrice" placeholder="Giá bán (VND)" min="0" /></div>
        <div style="display:flex;align-items:center"><button id="btnAddProd" class="btn small"><i data-feather="plus"></i> Thêm</button></div>
      </div>

      <table id="tblProducts">
        <thead>
          <tr><th>Tên hàng</th><th>Nhập</th><th>Đã bán</th><th>Tồn</th><th>Giá bán (VND)</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Order entry -->
    <div class="card" id="cardOrders">
      <h3>Bảng nhập đơn đặt hàng</h3>
      <div class="row">
        <div class="col"><input type="text" id="orderCustomer" placeholder="Khách hàng" /></div>
        <div class="col"><input type="text" id="orderAddress" placeholder="Địa chỉ" /></div>
        <div style="width:160px"><input type="text" id="orderPhone" placeholder="SĐT" /></div>
      </div>
      <div style="margin-top:8px">Danh sách mặt hàng (một khách có thể đặt nhiều loại). Mặc định có 2 dòng để nhập, bạn có thể thêm bớt.</div>
      <div id="itemsContainer" style="margin-top:8px"></div>
      <div class="row" style="margin-top:8px">
        <div style="width:160px"><button id="btnAddItem" class="btn small"><i data-feather="plus-square"></i> Thêm hàng</button></div>
        <div style="width:160px"><button id="btnCustomerFirst" class="btn small ghost"><i data-feather="chevrons-up"></i> Khách trước</button></div>
        <div style="width:160px"><button id="btnCustomerNext" class="btn small ghost"><i data-feather="chevrons-down"></i> Khách sau</button></div>
        <div class="right" style="width:220px">
          <div class="row"><div class="col small muted">Tổng tiền đơn:</div><div id="orderTotal" class="badge">0</div></div>
        </div>
      </div>
      <div style="margin-top:10px"><button id="btnAddOrder" class="btn"><i data-feather="plus"></i> Thêm đơn</button></div>
    </div>

    <!-- Orders list -->
    <div class="card">
      <h3>Bảng danh sách đơn</h3>
      <table id="tblOrders">
        <thead>
          <tr><th>STT</th><th>Khách hàng</th><th>Địa chỉ / SĐT</th><th>Danh sách đơn</th><th>Tổng tiền</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr><td colspan="4" class="right small muted">Tổng cả mã đơn:</td><td id="grandTotal">0</td><td></td></tr>
        </tfoot>
      </table>
    </div>

    <!-- Customers suggestion panel (collapsible, at bottom) -->
    <div class="card">
      <div style="display:flex;align-items:center;gap:12px">
        <h3 style="margin:0">Danh sách khách hàng (gợi ý)</h3>
        <button id="toggleCustomers" class="btn secondary small" style="margin-left:8px"><i data-feather="chevrons-down"></i> Hiện/Ẩn</button>
        <div class="right small muted">Kéo để xem khi danh sách dài</div>
      </div>
      <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
        <input id="customerSearch" type="text" placeholder="Tìm khách (tên hoặc SĐT)" style="flex:1;" />
        <input type="file" id="uploadCustomers" accept=".xlsx,.csv" />
      </div>
      <div id="customersPanel" class="customers-panel" style="margin-top:8px"></div>
      <div style="margin-top:10px"><input type="file" id="uploadCustomers" accept=".xlsx,.csv" /> <small class="muted">(Import cập nhật local & sẽ gửi lên Google Sheets khi bạn bấm Lưu)</small></div>
    </div>

    <div class="footer-note">Lưu ý: Trang này lưu local (localStorage) và cố gắng sync lên Google Sheets nếu bạn đặt <code>GS_URL</code> ở cấu hình.</div>
  </div>

  <!-- External libs: feather icons, SheetJS (xlsx), html2canvas + jsPDF for PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    /* ==========================
       CONFIG - chỉnh GS_URL ở đây
       ========================== */
    const GS_URL = ''; // <-- Dán Web App URL của bạn vào, ví dụ: 'https://script.google.com/macros/s/....../exec'
    const USE_REMOTE = GS_URL && GS_URL.includes('script.google.com');

    /* ================= utility ================= */
    function $(id){ return document.getElementById(id); }
    function fmtCurrency(v){ return Intl.NumberFormat('vi-VN').format(Number(v||0)); }

    function uid(prefix){ return prefix + '_' + Math.random().toString(36).slice(2,9); }

    /* ================ App state (in-memory) ================ */
    let batches = []; // {id, name, products:[], orders:[]}
    let customers = []; // {name,address,phone}
    let currentBatchId = null;

    const LS_KEY = 'ordergo_v1_data';

    /* ================ Persistence ================ */
    function persistAll(){ const payload = { batches, customers, currentBatchId }; localStorage.setItem(LS_KEY, JSON.stringify(payload)); }
    function loadLocal(){ const raw = localStorage.getItem(LS_KEY); if(raw){ try{ const d = JSON.parse(raw); batches = d.batches || []; customers = d.customers || []; currentBatchId = d.currentBatchId || (batches[0] && batches[0].id) || null; }catch(e){console.warn(e);} } }

    /* ================ UI renderers ================ */
    function renderBatchList(){ const sel = $('selBatches'); sel.innerHTML = ''; batches.forEach(b => { const opt = document.createElement('option'); opt.value = b.id; opt.textContent = b.name; if(b.id === currentBatchId) opt.selected = true; sel.appendChild(opt); }); if(batches.length===0){ const opt=document.createElement('option'); opt.value=''; opt.textContent='(Chưa có mã đơn tổng)'; sel.appendChild(opt);} }
    function getCurrentBatch(){ return batches.find(b=>b.id===currentBatchId); }

    function renderProducts(){ const tb = $('tblProducts').querySelector('tbody'); tb.innerHTML = ''; const b = getCurrentBatch(); if(!b){ tb.innerHTML = `<tr><td colspan="6" class="muted">Không có mã đơn. Hãy tạo mã mới hoặc bấm "Load mã" để tải các mã có sẵn từ Google Sheets.</td></tr>`; return; } b.products.forEach((p, idx)=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${p.name}</td><td>${p.in}</td><td>${p.sold||0}</td><td>${p.remain||0}</td><td>${fmtCurrency(p.price)}</td><td class="table-actions"><button data-idx="${idx}" title="Edit" class="icon-btn" data-action="edit"><i data-feather="edit-2"></i></button><button data-idx="${idx}" title="Xóa" class="icon-btn" data-action="delete"><i data-feather="trash-2"></i></button></td>`; tb.appendChild(tr); });
      // attach events
      tb.querySelectorAll('[data-action="delete"]').forEach(btn=>btn.addEventListener('click', (ev)=>{ const i=ev.target.closest('button').dataset.idx; if(confirm('Xóa sản phẩm?')){ getCurrentBatch().products.splice(i,1); persistAll(); renderProducts(); refreshItemSelectOptions(); renderOrders(); } }));
      tb.querySelectorAll('[data-action="edit"]').forEach(btn=>btn.addEventListener('click', (ev)=>{ const i=ev.target.closest('button').dataset.idx; editProduct(i); }));
      refreshItemSelectOptions();
    }

    function renderOrders(){ const tb = $('tblOrders').querySelector('tbody'); tb.innerHTML = ''; const b = getCurrentBatch(); if(!b){ tb.innerHTML = `<tr><td colspan="6" class="muted">Không có mã đơn. Hãy tạo mã mới hoặc bấm "Load mã" để tải các mã có sẵn từ Google Sheets.</td></tr>`; $('grandTotal').textContent = fmtCurrency(0); return; } let grand = 0; b.orders.forEach((o, idx)=>{ const itemsStr = Array.isArray(o.items) ? o.items.map(it => `${it.name} x${it.qty}`).join('<br/>') : o.items; grand += Number(o.total||0); const tr = document.createElement('tr'); tr.innerHTML = `<td>${idx+1}</td><td>${o.customer}</td><td class="wrap-text">${o.address} / ${o.phone}</td><td class="wrap-text">${itemsStr}</td><td>${fmtCurrency(o.total)}</td><td><button data-idx="${idx}" class="icon-btn" title="Edit"><i data-feather="edit-2"></i></button><button data-idx="${idx}" class="icon-btn" title="Xóa"><i data-feather="trash-2"></i></button></td>`; tb.appendChild(tr); });
      $('grandTotal').textContent = fmtCurrency(grand);
      tb.querySelectorAll('.icon-btn[title="Xóa"]').forEach(btn=>btn.addEventListener('click', (ev)=>{ const i=ev.target.closest('button').dataset.idx; if(confirm('Xóa đơn này?')){ getCurrentBatch().orders.splice(i,1); persistAll(); renderOrders(); renderProducts(); } }));
      tb.querySelectorAll('.icon-btn[title="Edit"]').forEach(btn=>btn.addEventListener('click', (ev)=>{ const i=ev.target.closest('button').dataset.idx; editOrder(i); }));
    }

    /* ================ Product & Order helpers ================ */
    function editProduct(index){ const b = getCurrentBatch(); const p = b.products[index]; const newName = prompt('Tên hàng', p.name); if(newName===null) return; p.name = newName; p.in = Number(prompt('Nhập', p.in) || p.in); p.price = Number(prompt('Giá bán', p.price) || p.price); p.remain = p.in - (p.sold||0); persistAll(); renderProducts(); }

    function editOrder(index){ const b = getCurrentBatch(); const o = b.orders[index]; $('orderCustomer').value = o.customer; $('orderAddress').value = o.address; $('orderPhone').value = o.phone; itemsContainerClear(); if(Array.isArray(o.items)){ o.items.forEach(it => addItemRow(it.name, it.qty)); } else { addItemRow('', 1); addItemRow('', 1); } updateOrderTotal(); b.orders.splice(index,1); persistAll(); renderOrders(); renderProducts(); }

    /* items container management */
    const itemsContainer = document.getElementById('itemsContainer');
    function itemsContainerClear(){ itemsContainer.innerHTML=''; }

    function refreshItemSelectOptions(){ // update all select lists in itemsContainer when products change
      const b = getCurrentBatch(); const prodNames = b ? b.products.map(p=>p.name) : [];
      Array.from(itemsContainer.querySelectorAll('select')).forEach(sel=>{
        const oldVal = sel.value;
        sel.innerHTML = '';
        const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent='-- Chọn hàng --'; sel.appendChild(opt0);
        if(prodNames.length===0){ const opt = document.createElement('option'); opt.value=''; opt.textContent='(Chưa có hàng hóa)'; sel.appendChild(opt); }
        prodNames.forEach(name=>{ const o=document.createElement('option'); o.value = name; o.textContent = name; if(name === oldVal) o.selected = true; sel.appendChild(o); });
      });
    }

    function addItemRow(prefName, prefQty){ const row = document.createElement('div'); row.className = 'row'; row.style.marginTop='8px'; const sel = document.createElement('select'); sel.style.width='40%'; sel.className='item-select'; const inpQty = document.createElement('input'); inpQty.type='number'; inpQty.min=0; inpQty.value=prefQty||1; inpQty.style.width='120px'; const btnDel = document.createElement('button'); btnDel.textContent='Xóa'; btnDel.type='button'; btnDel.className='btn small ghost'; btnDel.style.marginLeft='8px'; row.appendChild(sel); const spacer=document.createElement('div'); spacer.style.width='12px'; row.appendChild(spacer); row.appendChild(inpQty); row.appendChild(btnDel); itemsContainer.appendChild(row);
      btnDel.addEventListener('click', ()=>{ row.remove(); updateOrderTotal(); });
      sel.addEventListener('change', ()=>{ updateOrderTotal(); });
      inpQty.addEventListener('input', ()=>{ updateOrderTotal(); });
      refreshItemSelectOptions(); if(prefName) sel.value = prefName; return row; }

    function updateOrderTotal(){ const rows = Array.from(itemsContainer.children); let total = 0; rows.forEach(r=>{ const sel = r.querySelector('select'); const qty = Number(r.querySelector('input[type=number]').value||0); const prod = getCurrentBatch() ? getCurrentBatch().products.find(p=>p.name===sel.value) : null; if(prod) total += Number(prod.price||0) * qty; }); $('orderTotal').textContent = fmtCurrency(total); return total; }

    /* ================ Actions ================ */
    function createNewBatchPrompt(){ let name = prompt('Tên mã đơn tổng (có thể để trống để dùng ngày giờ):', ''); if(name===null) return; name = String(name || '').trim(); const d = new Date(); const pad=(n)=>String(n).padStart(2,'0'); const prefix = `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}`; let final = (name ? `${prefix} ${name}` : `${prefix}`); const sanitized = sanitizeForSheetName(final); if(sanitized !== final){ if(!confirm(`Tên sẽ được chuẩn hóa: ${sanitized}
Bạn đồng ý?`)) return; final = sanitized; } else final = sanitized; const id = uid('batch'); const b = { id, name: final, products: [], orders: [], timestamp: new Date().toISOString() }; batches.unshift(b); currentBatchId = id; persistAll(); renderAll(); alert(`Đã tạo batch: ${final}`); }

    function addProductFromForm(){ const name = $('prodName').value.trim(); if(!name){ alert('Tên hàng không được trống'); return; } const pin = Number($('prodIn').value||0); const price = Number($('prodPrice').value||0); const b = getCurrentBatch(); if(!b){ alert('Chọn hoặc tạo mã đơn tổng trước'); return; } b.products.push({ name, in: pin, sold:0, remain: pin, price }); $('prodName').value=''; $('prodIn').value=''; $('prodPrice').value=''; persistAll(); renderProducts(); refreshItemSelectOptions(); }

    function addItemToOrder(){ addItemRow('',1); }

    function addOrderFromForm(){ const b = getCurrentBatch(); if(!b){ alert('Chọn mã đơn tổng trước'); return; } const customer = $('orderCustomer').value.trim(); const address = $('orderAddress').value.trim(); const phone = $('orderPhone').value.trim(); if(!customer){ alert('Nhập tên khách hàng'); return; } const items = []; Array.from(itemsContainer.children).forEach(r=>{ const name = r.querySelector('select').value; const qty = Number(r.querySelector('input[type=number]').value||0); if(name && qty>0) items.push({ name, qty }); }); if(items.length===0){ alert('Phải có ít nhất 1 mặt hàng với số lượng > 0'); return; } const total = updateOrderTotal(); const order = { customer, address, phone, items, total, created: new Date().toISOString() }; b.orders.push(order); items.forEach(it => { const p = b.products.find(pp=>pp.name===it.name); if(p){ p.sold = (p.sold||0) + Number(it.qty); p.remain = (p.in||0) - p.sold; if(p.remain < 0) p.remain = 0; } }); if(!customers.some(c=>c.name===customer && c.phone===phone)){ customers.unshift({ name:customer, address, phone }); }
      $('orderCustomer').value=''; $('orderAddress').value=''; $('orderPhone').value=''; itemsContainerClear(); addItemRow('',1); addItemRow('',1); $('orderTotal').textContent = fmtCurrency(0); persistAll(); renderAll(); }

    /* ================ Save local + remote ================ */
    function saveLocal(){ persistAll(); $('saveLabel').textContent = 'Đã lưu (local)'; setTimeout(()=> $('saveLabel').textContent='Lưu',900); if(USE_REMOTE) gsSaveAll(); }

    async function gsSaveAll(){ if(!USE_REMOTE) return false; try{ const payload = { action:'saveAll', data: { batches, customers, currentBatchId } }; const resp = await fetch(GS_URL, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) }); const j = await resp.json(); if(j && j.ok){ console.log('gsSaveAll ok'); return true; } else { console.warn('gsSaveAll server error', j); alert('Lưu lên Google Sheets thất bại: ' + (j && j.error ? j.error : 'Server error')); return false; } } catch(err){ console.error('gsSaveAll error', err); alert('Lỗi khi lưu lên Google Sheets.'); return false; } }

    async function gsLoadAll(){ if(!USE_REMOTE) return false; try{ const resp = await fetch(GS_URL + '?action=readAll'); const j = await resp.json(); if(j && j.ok && j.data){ const remote = j.data; const remoteBatches = (remote.batches || []).map(rb => ({ id: rb.id || rb.name, name: rb.name, products: rb.products || [], orders: rb.orders || [] })); if(remoteBatches.length) batches = remoteBatches; if(remote.customers && remote.customers.length) customers = remote.customers.concat(customers.filter(c=>!remote.customers.some(rc=>rc.name===c.name && rc.phone===c.phone))); currentBatchId = remote.currentBatchId || (batches[0] && batches[0].id) || currentBatchId; persistAll(); renderAll(); return true; } return false; } catch(err){ console.error('gsLoadAll error', err); return false; } }

    /* ================ Import customers (xlsx/csv) ================ */
    function handleUploadCustomers(file){ const reader = new FileReader(); reader.onload = function(e){ const data = e.target.result; let workbook = null; try{ workbook = XLSX.read(data, {type: 'binary'}); } catch(ex){ try{ workbook = XLSX.read(data, {type: 'string'}); } catch(e2){ alert('Không đọc được file'); return; } } const firstSheetName = workbook.SheetNames[0]; const ws = workbook.Sheets[firstSheetName]; const arr = XLSX.utils.sheet_to_json(ws, { header:1 }); arr.slice(1).forEach(r=>{ const name = r[0]||''; const addr = r[1]||''; const phone = r[2]||''; if(name) customers.unshift({ name, address:addr, phone }); }); persistAll(); renderCustomersPanel(); alert('Import customers hoàn tất'); }; reader.readAsBinaryString(file); }

    /* ================ Customers panel render ================ */
    function renderCustomersPanel(){ const panel = $('customersPanel'); panel.innerHTML = ''; if(!customers.length){ panel.innerHTML = '<div class="small muted">(Chưa có dữ liệu khách hàng)</div>'; return; } customers.forEach(c=>{ const row = document.createElement('div'); row.className = 'customer-row'; row.innerHTML = `<div><strong>${c.name}</strong><div class="small muted">${c.address} • ${c.phone}</div></div>`; row.addEventListener('click', ()=>{ $('orderCustomer').value = c.name; $('orderAddress').value = c.address; $('orderPhone').value = c.phone; }); panel.appendChild(row); }); }

    /* ================ Exports ================ */
    function exportExcel(){ const wb = XLSX.utils.book_new(); const b = getCurrentBatch(); if(!b){ alert('Chọn batch trước khi xuất'); return; } const prows = [["Tên hàng","Nhập","Đã bán","Tồn","Giá bán"]].concat((b.products||[]).map(p=>[p.name,p.in,p.sold||0,p.remain||0,p.price])); const ws1 = XLSX.utils.aoa_to_sheet(prows); XLSX.utils.book_append_sheet(wb, ws1, 'Products'); const orows = [["STT","Khách hàng","Địa chỉ","SĐT","Danh sách đơn","Tổng tiền","Ngày"]].concat((b.orders||[]).map((o,idx)=>[idx+1,o.customer,o.address,o.phone,(Array.isArray(o.items)?o.items.map(it=>it.name+' x'+it.qty).join('; '):o.items),o.total,o.created])); const ws2 = XLSX.utils.aoa_to_sheet(orows); XLSX.utils.book_append_sheet(wb, ws2, 'Orders'); XLSX.writeFile(wb, `${b.name || 'batch'}_export.xlsx`); }

    async function exportPDF(){ const b = getCurrentBatch(); if(!b){ alert('Chọn batch trước khi xuất'); return; } const tmp = document.createElement('div'); tmp.style.padding='20px'; tmp.style.background='white'; tmp.style.width='800px'; tmp.innerHTML = `<h2>${b.name}</h2><h3>Orders</h3><table border=1 style='border-collapse:collapse;width:100%'><thead><tr><th>STT</th><th>Khách</th><th>Items</th><th>Total</th></tr></thead><tbody>${(b.orders||[]).map((o,i)=>`<tr><td>${i+1}</td><td>${o.customer}<br/>${o.phone}</td><td>${Array.isArray(o.items)?o.items.map(it=>it.name+' x'+it.qty).join('<br/>'):o.items}</td><td>${fmtCurrency(o.total)}</td></tr>`).join('')}</tbody></table>`; document.body.appendChild(tmp); await html2canvas(tmp, { scale:2 }).then(canvas=>{ const imgData = canvas.toDataURL('image/png'); const { jsPDF } = window.jspdf; const pdf = new jsPDF('p', 'pt', 'a4'); const imgProps = pdf.getImageProperties(imgData); const pdfWidth = pdf.internal.pageSize.getWidth(); const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width; pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight); pdf.save(`${b.name || 'batch'}_orders.pdf`); }).catch(err=>{ alert('Xuất PDF lỗi: '+err.message); }).finally(()=>{ tmp.remove(); }); }

    /* ================ Init & events ================ */
    function renderAll(){ renderBatchList(); renderProducts(); renderOrders(); renderCustomersPanel(); feather.replace(); }

    function attachHandlers(){
      $('btnNewBatch').addEventListener('click', ()=>createNewBatchPrompt());
      $('selBatches').addEventListener('change', (e)=>{ currentBatchId = e.target.value; persistAll(); renderAll(); });
      $('btnAddProd').addEventListener('click', addProductFromForm);
      $('btnAddItem').addEventListener('click', addItemToOrder);
      $('btnAddOrder').addEventListener('click', addOrderFromForm);
      $('btnCustomerFirst').addEventListener('click', ()=>{ const idx = customers.findIndex(c=>c.name && c.name.toLowerCase().includes($('orderCustomer').value.toLowerCase())); if(idx>-1){ $('orderCustomer').value = customers[idx].name; $('orderAddress').value = customers[idx].address; $('orderPhone').value = customers[idx].phone; } });
      $('btnCustomerNext').addEventListener('click', ()=>{ const idx = customers.findIndex(c=>c.name && c.name.toLowerCase().includes($('orderCustomer').value.toLowerCase())); if(idx>-1 && idx<customers.length-1){ const c=customers[idx+1]; $('orderCustomer').value=c.name; $('orderAddress').value=c.address; $('orderPhone').value=c.phone; }});
      $('uploadCustomers').addEventListener('change',(ev)=>{ const f=ev.target.files[0]; if(f) handleUploadCustomers(f); });
      $('btnSave').addEventListener('click', ()=>saveLocal());
      $('btnExportExcel').addEventListener('click', ()=>exportExcel());
      $('btnExportPDF').addEventListener('click', ()=>exportPDF());
      $('toggleCustomers').addEventListener('click', ()=>{ const p=$('customersPanel'); if(p.classList.contains('collapsed')){ p.classList.remove('collapsed'); } else { p.classList.add('collapsed'); } });
      document.addEventListener('input', (ev)=>{ if(ev.target && ev.target.closest && ev.target.closest('#itemsContainer')) updateOrderTotal(); });
      $('customerSearch').addEventListener('input', (ev)=>{ const q = ev.target.value.toLowerCase(); const found = customers.filter(c=> (c.name||'').toLowerCase().includes(q) || (c.phone||'').toLowerCase().includes(q)); if(found.length){ const c=found[0]; $('orderCustomer').value=c.name; $('orderAddress').value=c.address; $('orderPhone').value=c.phone; } });

      // NEW: load batches button
      const loadBtn = $('btnLoadBatches');
      if(loadBtn){
        loadBtn.addEventListener('click', async ()=>{
          if(!USE_REMOTE){ alert('GS_URL chưa cấu hình. Vui lòng đặt GS_URL trong cấu hình để load từ Google Sheets.'); return; }
          loadBtn.textContent = 'Đang tải...'; loadBtn.disabled = true;
          try{
            const ok = await gsLoadAll();
            if(ok){ alert('Đã load tất cả mã từ Google Sheets vào local.'); } else { alert('Không load được dữ liệu từ Google Sheets.'); }
          } catch(e){ console.error('Load batches error', e); alert('Lỗi khi load dữ liệu. Xem console.'); }
          finally{ loadBtn.disabled = false; loadBtn.textContent = 'Load mã'; }
        });
      }

      // keyboard: Enter on orderCustomer fill suggestion (optional)
      const oc = $('orderCustomer'); if(oc){ oc.addEventListener('change', ()=>{ const q = oc.value; const found = customers.filter(c=> c.name && c.name.toLowerCase() === q.toLowerCase()); if(found.length){ $('orderAddress').value = found[0].address; $('orderPhone').value = found[0].phone; } }); }
    }); $('btnAddProd').addEventListener('click', addProductFromForm); $('btnAddItem').addEventListener('click', addItemToOrder); $('btnAddOrder').addEventListener('click', addOrderFromForm); $('btnCustomerFirst').addEventListener('click', ()=>{ const idx = customers.findIndex(c=>c.name && c.name.toLowerCase().includes($('orderCustomer').value.toLowerCase())); if(idx>-1){ $('orderCustomer').value = customers[idx].name; $('orderAddress').value = customers[idx].address; $('orderPhone').value = customers[idx].phone; } }); $('btnCustomerNext').addEventListener('click', ()=>{ const idx = customers.findIndex(c=>c.name && c.name.toLowerCase().includes($('orderCustomer').value.toLowerCase())); if(idx>-1 && idx<customers.length-1){ const c=customers[idx+1]; $('orderCustomer').value=c.name; $('orderAddress').value=c.address; $('orderPhone').value=c.phone; }}); $('uploadCustomers').addEventListener('change',(ev)=>{ const f=ev.target.files[0]; if(f) handleUploadCustomers(f); }); $('btnSave').addEventListener('click', ()=>saveLocal()); $('btnExportExcel').addEventListener('click', ()=>exportExcel()); $('btnExportPDF').addEventListener('click', ()=>exportPDF()); $('toggleCustomers').addEventListener('click', ()=>{ const p=$('customersPanel'); if(p.classList.contains('collapsed')){ p.classList.remove('collapsed'); } else { p.classList.add('collapsed'); } }); document.addEventListener('input', (ev)=>{ if(ev.target && ev.target.closest && ev.target.closest('#itemsContainer')) updateOrderTotal(); }); $('customerSearch').addEventListener('input', (ev)=>{ const q = ev.target.value.toLowerCase(); const found = customers.filter(c=> (c.name||'').toLowerCase().includes(q) || (c.phone||'').toLowerCase().includes(q)); if(found.length){ const c=found[0]; $('orderCustomer').value=c.name; $('orderAddress').value=c.address; $('orderPhone').value=c.phone; } }); }

    // initial setup
    loadLocal();
    // DO NOT auto-create a default batch. Let user create or load from remote.
    // Prepare item entry rows (still allow entry UI but operations will validate current batch)
    itemsContainerClear(); addItemRow('',1); addItemRow('',1);
    attachHandlers(); renderAll();

    // Note: user can click 'Load mã' to fetch all batches from Google Sheets into local storage
    // If you want to auto-load on start, uncomment the following:
    // if(USE_REMOTE){ gsLoadAll().then(ok=>{ if(ok) console.log('Loaded remote on start'); }); }

    window.ordergo = { batches, customers, persistAll, gsSaveAll, gsLoadAll };
    window.ordergo = { batches, customers, persistAll, gsSaveAll, gsLoadAll };
  </script>
</body>
</html>
