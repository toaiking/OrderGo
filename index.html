function exportExcel(){
  if (typeof XLSX === 'undefined') {
    alert('Lỗi: Thư viện xuất Excel chưa được tải. Vui lòng kiểm tra kết nối mạng và thử lại.');
    return;
  }
  try{
    const currentB = getCurrentBatch();
    if(!currentB){ alert('Chưa chọn batch để xuất.'); return; }

    const wb = XLSX.utils.book_new();

    // Products sheet
    const prodRows = [['Tên hàng', 'Nhập', 'Đã bán', 'Tồn', 'Giá bán']].concat(
      (currentB.products || []).map(p => [p.name, p.in, p.sold, p.remain, p.price])
    );
    const wsP = XLSX.utils.aoa_to_sheet(prodRows);
    XLSX.utils.book_append_sheet(wb, wsP, 'Products_' + sanitizeForSheetName(currentB.name));

    // Orders sheet (safely normalize items)
    const orderHeaders = ['Thời gian','Khách hàng', 'Địa chỉ', 'SĐT', 'Ghi chú', 'Tổng tiền', 'Danh sách hàng'];
    const orderRows = (currentB.orders || []).map(o => {
      // Normalize items to an array safely (accept Array, string, or object)
      let itemsArr = [];
      try {
        if (Array.isArray(o.items)) {
          itemsArr = o.items;
        } else if (typeof o.items === 'string' && o.items.trim() !== '') {
          // split common separators ; , <br> newline
          const parts = o.items.split(/;|<br\s*\/?>|,|\n/).map(s => s.trim()).filter(Boolean);
          itemsArr = parts.map(p => {
            const m = p.match(/(.+?)\s*x\s*(\d+)$/i);
            if (m) return { name: m[1].trim(), qty: Number(m[2]) };
            return { name: p, qty: '' };
          });
        } else if (o.items && typeof o.items === 'object') {
          itemsArr = Object.values(o.items).map(it => {
            const name = it && (it.name || it.product) ? (it.name || it.product) : String(it);
            const qty = it && (it.qty || it.count) ? (it.qty || it.count) : '';
            return { name, qty };
          });
        } else {
          itemsArr = [];
        }
      } catch(e) {
        itemsArr = [];
      }

      const itemDetails = (itemsArr || []).map(i => `${i.name} x${i.qty}`).join('; ');
      return [o.created, o.customer, o.address, o.phone, o.note||'', o.total, itemDetails];
    });

    const wsO = XLSX.utils.aoa_to_sheet([orderHeaders].concat(orderRows));
    XLSX.utils.book_append_sheet(wb, wsO, 'Orders_' + sanitizeForSheetName(currentB.name));

    XLSX.writeFile(wb, `ordergo_export_${new Date().toISOString().slice(0,10)}.xlsx`);
  } catch(e){
    console.error(e);
    alert('Lỗi khi xuất Excel: ' + e.message);
  }
}
