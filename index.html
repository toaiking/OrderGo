<script>
    // ---------- CONFIG ----------
    const GS_URL = 'https://script.google.com/macros/s/AKfycbz-1WXX8s2HEtYaNu11HR8S8pUzSgkb5nHq8KWMm-xoLfCmIssBsWQhIo-qjM03FbZK/exec';
    const USE_REMOTE = GS_URL && GS_URL.includes('script.google.com');

    // ---------- STATE ----------
    let batches = [];
    let customers = [];
    let currentBatchId = null;
    let currentEditingOrderIndex = -1; // -1 means new order, >= 0 means editing
    const LS_KEY = 'ordergo_v2_data';

    // ---------- UTILS ----------
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);
    const fmtCurrency = (v) => new Intl.NumberFormat('vi-VN').format(Number(v || 0));
    const uid = (prefix) => prefix + '_' + Math.random().toString(36).slice(2, 9);
    const ensureIcons = () => { if(window.feather) setTimeout(() => feather.replace(), 50); };

    // ---------- PERSISTENCE ----------
    const persistAll = () => localStorage.setItem(LS_KEY, JSON.stringify({ batches, customers, currentBatchId }));
    const loadLocal = () => {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return;
      try {
        const d = JSON.parse(raw);
        batches = d.batches || [];
        customers = d.customers || [];
        currentBatchId = d.currentBatchId || (batches[0]?.id) || null;
      } catch (e) { console.warn("Error loading local data:", e); }
    };

    // ---------- RENDER FUNCTIONS ----------
    const renderAll = () => {
      renderBatchList();
      renderProducts();
      renderOrders();
      renderCustomersPanel();
      resetOrderForm();
      ensureIcons();
    };

    const renderBatchList = () => {
      const sel = $('#selBatches');
      sel.innerHTML = '';
      if (batches.length === 0) {
        sel.innerHTML = '<option value="">(Chưa có mã nào)</option>';
        return;
      }
      batches.sort((a, b) => (b.name > a.name) ? 1 : -1); // Sort batches by name desc
      batches.forEach(b => {
        const opt = document.createElement('option');
        opt.value = b.id;
        opt.textContent = b.name;
        if (b.id === currentBatchId) opt.selected = true;
        sel.appendChild(opt);
      });
    };

    const renderProducts = () => {
        const tbody = $('#tblProducts tbody');
        tbody.innerHTML = '';
        const batch = getCurrentBatch();
        if (!batch) return;
        batch.products.forEach((p, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${p.name}</td>
                <td>${p.in}</td>
                <td>${p.sold || 0}</td>
                <td>${p.remain || 0}</td>
                <td>${fmtCurrency(p.price)}</td>
                <td>
                    <button class="icon-btn" data-action="edit-product" data-index="${index}" title="Sửa"><i data-feather="edit-2"></i></button>
                    <button class="icon-btn" data-action="delete-product" data-index="${index}" title="Xóa"><i data-feather="trash-2"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        refreshItemSelectOptions();
    };
    
    const renderOrders = () => {
        const tbody = $('#tblOrders tbody');
        tbody.innerHTML = '';
        const batch = getCurrentBatch();
        if (!batch) return;
        
        let grandTotal = 0;
        batch.orders.forEach((o, index) => {
            const itemsStr = (o.items || []).map(it => `${it.name} x${it.qty}`).join('<br>');
            grandTotal += o.total || 0;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td>${o.customer}</td>
                <td>${o.address}<br><span class="small muted">${o.phone}</span></td>
                <td>${itemsStr}</td>
                <td>${fmtCurrency(o.total)}</td>
                <td>
                    <button class="icon-btn" data-action="edit-order" data-index="${index}" title="Tải lại đơn để sửa"><i data-feather="edit"></i></button>
                    <button class="icon-btn" data-action="delete-order" data-index="${index}" title="Xóa đơn"><i data-feather="trash-2"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        $('#grandTotal').textContent = fmtCurrency(grandTotal);
    };

    const renderCustomersPanel = (filteredCustomers = customers) => {
      const panel = $('#customersPanel');
      panel.innerHTML = '';
      if (!filteredCustomers || filteredCustomers.length === 0) {
        panel.innerHTML = '<div class="small muted" style="padding:8px;">(Chưa có dữ liệu khách hàng)</div>';
        return;
      }
      filteredCustomers.forEach(c => {
        const row = document.createElement('div');
        row.className = 'customer-row';
        row.innerHTML = `<div><strong>${c.name}</strong><div class="small muted">${c.address || ''} &bull; ${c.phone || ''}</div></div>`;
        row.addEventListener('click', () => {
          $('#orderCustomer').value = c.name;
          $('#orderAddress').value = c.address;
          $('#orderPhone').value = c.phone;
          $('#customer-suggestions').classList.add('hidden');
        });
        panel.appendChild(row);
      });
    };
    
    // ---------- ACTION FUNCTIONS ----------
    const getCurrentBatch = () => batches.find(b => b.id === currentBatchId);

    const createNewBatch = (silent = false) => {
        let name;
        if (!silent) {
            name = prompt('Tên mã đơn tổng (để trống sẽ tự tạo theo ngày):', '');
            if (name === null) return;
        }
        name = String(name || '').trim();
        const d = new Date();
        const prefix = `${d.getFullYear()}${String(d.getMonth() + 1).padStart(2, '0')}${String(d.getDate()).padStart(2, '0')}`;
        const finalName = name ? `${prefix} - ${name}` : `Mã ngày ${prefix}`;
        
        const id = uid('batch');
        const newBatch = { id, name: finalName, products: [], orders: [] };
        batches.unshift(newBatch);
        currentBatchId = id;
        persistAll();
        renderAll();
        if (!silent) alert(`Đã tạo mã: ${finalName}`);
    };

    const deleteCurrentBatch = () => {
        const batch = getCurrentBatch();
        if (!batch) {
            alert("Không có mã nào để xóa.");
            return;
        }
        if (confirm(`Bạn có chắc muốn XÓA VĨNH VIỄN mã "${batch.name}" và toàn bộ đơn hàng trong đó?`)) {
            batches = batches.filter(b => b.id !== currentBatchId);
            currentBatchId = batches[0]?.id || null;
            persistAll();
            renderAll();
        }
    };
    
    const addProductFromForm = () => {
        const batch = getCurrentBatch();
        if (!batch) {
            alert("Vui lòng tạo hoặc chọn một mã trước khi thêm hàng.");
            return;
        }
        const name = $('#prodName').value.trim();
        const p_in = Number($('#prodIn').value) || 0;
        const price = Number($('#prodPrice').value) || 0;
        if (!name) {
            alert("Tên hàng không được để trống.");
            return;
        }
        
        batch.products.push({ name, in: p_in, sold: 0, remain: p_in, price });
        persistAll();
        renderProducts();
        $('#prodName').value = '';
        $('#prodIn').value = '';
        $('#prodPrice').value = '';
        $('#prodName').focus();
    };

    const addOrUpdateOrderFromForm = () => {
        const batch = getCurrentBatch();
        if (!batch) {
            alert("Vui lòng tạo hoặc chọn một mã trước.");
            return;
        }
        const customer = $('#orderCustomer').value.trim();
        if (!customer) {
            alert("Tên khách hàng không được để trống.");
            return;
        }
        
        const items = [];
        $$('#itemsContainer .row').forEach(row => {
            const name = row.querySelector('.item-select').value;
            const qty = Number(row.querySelector('.item-qty').value);
            if (name && qty > 0) {
                items.push({ name, qty });
            }
        });

        if (items.length === 0) {
            alert("Đơn hàng phải có ít nhất một sản phẩm với số lượng > 0.");
            return;
        }
        
        const orderData = {
            customer,
            address: $('#orderAddress').value.trim(),
            phone: $('#orderPhone').value.trim(),
            items,
            total: calculateOrderTotal(),
            created: new Date().toISOString()
        };
        
        // Update product stock before saving order
        updateStockForOrder(batch, orderData.items);

        if (currentEditingOrderIndex > -1) {
            // Update existing order
            batch.orders[currentEditingOrderIndex] = orderData;
        } else {
            // Add new order
            batch.orders.push(orderData);
        }
        
        // Update customer list
        const existingCustomer = customers.find(c => c.name.toLowerCase() === customer.toLowerCase());
        if(existingCustomer) {
            existingCustomer.address = orderData.address;
            existingCustomer.phone = orderData.phone;
        } else {
            customers.unshift({ name: customer, address: orderData.address, phone: orderData.phone });
        }

        persistAll();
        renderAll();
    };

    const updateStockForOrder = (batch, items) => {
        // Recalculate all stock based on all orders to prevent errors
        batch.products.forEach(p => {
            p.sold = 0;
        });

        batch.orders.forEach(order => {
            (order.items || []).forEach(item => {
                const product = batch.products.find(p => p.name === item.name);
                if (product) {
                    product.sold += Number(item.qty);
                }
            });
        });
        
        batch.products.forEach(p => {
            p.remain = p.in - p.sold;
        });
    };
    
    const resetOrderForm = () => {
        currentEditingOrderIndex = -1;
        $('#orderCustomer').value = '';
        $('#orderAddress').value = '';
        $('#orderPhone').value = '';
        $('#itemsContainer').innerHTML = '';
        addItemRow();
        addItemRow();
        updateOrderTotal();
        $('#btnAddOrder').textContent = 'Thêm đơn';
        $('#orderNavStatus').textContent = '(Đơn mới)';
    };

    // ---------- ITEM ROW HELPERS ----------
    const addItemRow = (name = '', qty = 1) => {
        const batch = getCurrentBatch();
        const row = document.createElement('div');
        row.className = 'row';
        row.style.alignItems = 'center';
        
        const options = (batch?.products || []).map(p => `<option value="${p.name}">${p.name}</option>`).join('');
        
        row.innerHTML = `
            <div class="col" style="flex:2.5;"><select class="item-select"><option value="">-- Chọn hàng --</option>${options}</select></div>
            <div class="col" style="flex:1;"><input type="number" class="item-qty" min="1" value="${qty}" placeholder="SL"></div>
            <div style="flex:0.2;"><button class="icon-btn btn-del-item" title="Xóa dòng"><i data-feather="x-circle"></i></button></div>
        `;
        $('#itemsContainer').appendChild(row);
        row.querySelector('.item-select').value = name;
        ensureIcons();
    };

    const calculateOrderTotal = () => {
        const batch = getCurrentBatch();
        if (!batch) return 0;
        let total = 0;
        $$('#itemsContainer .row').forEach(row => {
            const name = row.querySelector('.item-select').value;
            const qty = Number(row.querySelector('.item-qty').value);
            const product = batch.products.find(p => p.name === name);
            if (product) {
                total += (product.price || 0) * qty;
            }
        });
        return total;
    };
    
    const updateOrderTotal = () => {
        const total = calculateOrderTotal();
        $('#orderTotal').textContent = fmtCurrency(total);
    };

    const refreshItemSelectOptions = () => {
        $$('.item-select').forEach(sel => {
            const batch = getCurrentBatch();
            const currentValue = sel.value;
            const options = (batch?.products || []).map(p => `<option value="${p.name}" ${p.name === currentValue ? 'selected' : ''}>${p.name}</option>`).join('');
            sel.innerHTML = `<option value="">-- Chọn hàng --</option>${options}`;
        });
    };
    
    // ---------- EVENT HANDLERS & NAVIGATION ----------
    const handleProductTableClick = (e) => {
        const button = e.target.closest('button[data-action]');
        if (!button) return;

        const index = Number(button.dataset.index);
        const action = button.dataset.action;
        const batch = getCurrentBatch();
        const product = batch.products[index];

        if (action === 'delete-product') {
            if (confirm(`Bạn có chắc muốn xóa sản phẩm "${product.name}"?`)) {
                batch.products.splice(index, 1);
                persistAll();
                renderAll();
            }
        } else if (action === 'edit-product') {
            const newName = prompt("Sửa tên hàng:", product.name);
            const newIn = prompt("Sửa số lượng nhập:", product.in);
            const newPrice = prompt("Sửa giá bán:", product.price);
            if(newName) product.name = newName;
            if(newIn !== null) product.in = Number(newIn);
            if(newPrice !== null) product.price = Number(newPrice);
            product.remain = product.in - (product.sold || 0);
            persistAll();
            renderAll();
        }
    };

    const handleOrderTableClick = (e) => {
        const button = e.target.closest('button[data-action]');
        if (!button) return;

        const index = Number(button.dataset.index);
        const action = button.dataset.action;
        const batch = getCurrentBatch();
        const order = batch.orders[index];

        if (action === 'delete-order') {
            if (confirm(`Bạn có chắc muốn xóa đơn hàng của khách "${order.customer}"?`)) {
                batch.orders.splice(index, 1);
                updateStockForOrder(batch, []); // Recalculate stock
                persistAll();
                renderAll();
            }
        } else if (action === 'edit-order') {
            loadOrderIntoForm(index);
        }
    };
    
    const loadOrderIntoForm = (index) => {
        const batch = getCurrentBatch();
        if (!batch || !batch.orders[index]) return;
        
        const order = batch.orders[index];
        currentEditingOrderIndex = index;
        
        $('#orderCustomer').value = order.customer;
        $('#orderAddress').value = order.address;
        $('#orderPhone').value = order.phone;
        
        $('#itemsContainer').innerHTML = '';
        (order.items || []).forEach(item => addItemRow(item.name, item.qty));
        updateOrderTotal();
        
        $('#btnAddOrder').textContent = 'Cập nhật đơn';
        $('#orderNavStatus').textContent = `(Đơn ${index + 1}/${batch.orders.length})`;
    };
    
    const navigateOrder = (direction) => {
        const batch = getCurrentBatch();
        if (!batch || batch.orders.length === 0) return;
        
        let newIndex = currentEditingOrderIndex + direction;
        
        if (newIndex >= batch.orders.length) newIndex = 0; // Wrap around to first
        if (newIndex < 0) newIndex = batch.orders.length - 1; // Wrap around to last
        
        loadOrderIntoForm(newIndex);
    };

    const showCustomerSuggestions = (e) => {
        const input = e.target;
        const query = input.value.toLowerCase();
        const suggestionsPanel = $('#customer-suggestions');
        
        if (query.length < 1) {
            suggestionsPanel.classList.add('hidden');
            return;
        }

        const filtered = customers.filter(c => c.name.toLowerCase().includes(query) || c.phone.includes(query));
        suggestionsPanel.innerHTML = '';

        if (filtered.length > 0) {
            filtered.slice(0, 5).forEach(c => { // Show max 5 suggestions
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.textContent = `${c.name} - ${c.phone}`;
                item.addEventListener('mousedown', () => { // mousedown to fire before blur
                    input.value = c.name;
                    $('#orderAddress').value = c.address;
                    $('#orderPhone').value = c.phone;
                    suggestionsPanel.classList.add('hidden');
                });
                suggestionsPanel.appendChild(item);
            });
            suggestionsPanel.classList.remove('hidden');
        } else {
            suggestionsPanel.classList.add('hidden');
        }
    };
    
    // ---------- FILE & REMOTE ----------
    const handleUploadCustomers = (file) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const workbook = XLSX.read(e.target.result, { type: 'binary' });
                const ws = workbook.Sheets[workbook.SheetNames[0]];
                const arr = XLSX.utils.sheet_to_json(ws, { header: ["name", "address", "phone"], range: 1 });
                let newCount = 0, updatedCount = 0;
                
                arr.forEach(row => {
                    const name = String(row.name || '').trim();
                    if (!name) return;
                    const existing = customers.find(c => c.name.toLowerCase() === name.toLowerCase());
                    if (existing) {
                        existing.address = String(row.address || existing.address).trim();
                        existing.phone = String(row.phone || existing.phone).trim();
                        updatedCount++;
                    } else {
                        customers.push({ name, address: String(row.address || '').trim(), phone: String(row.phone || '').trim() });
                        newCount++;
                    }
                });
                persistAll();
                renderCustomersPanel();
                alert(`Import hoàn tất!\n- Thêm mới: ${newCount} khách\n- Cập nhật: ${updatedCount} khách`);
            } catch (err) {
                alert('Không đọc được file. Vui lòng kiểm tra định dạng.');
            }
        };
        reader.readAsBinaryString(file);
    };

    const exportCurrentBatchToExcel = () => {
        const batch = getCurrentBatch();
        if (!batch) { alert("Vui lòng chọn một mã để xuất."); return; }
        const ws_orders = XLSX.utils.json_to_sheet(batch.orders.flatMap((o, i) =>
            o.items.map((it, ii) => ({
                STT: ii === 0 ? i + 1 : '',
                'Khách hàng': ii === 0 ? o.customer : '',
                'Địa chỉ': ii === 0 ? o.address : '',
                'SĐT': ii === 0 ? o.phone : '',
                'Sản phẩm': it.name,
                'Số lượng': it.qty,
                'Tổng đơn': ii === 0 ? o.total : ''
            }))
        ));
        const ws_products = XLSX.utils.json_to_sheet(batch.products);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws_orders, "Danh sách đơn");
        XLSX.utils.book_append_sheet(wb, ws_products, "Thống kê hàng hóa");
        XLSX.writeFile(wb, `${batch.name}.xlsx`);
    };

    const saveAll = async () => {
        persistAll();
        const btnSave = $('#btnSave');
        const label = $('#saveLabel');
        label.textContent = 'Đã lưu local';
        
        if (!USE_REMOTE) return;

        btnSave.disabled = true;
        label.textContent = 'Đang gửi GS...';
        try {
            const payload = { action: 'saveAll', data: { batches, customers, currentBatchId } };
            const resp = await fetch(GS_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await resp.json();
            if (result.ok) {
                 label.textContent = 'Đã gửi GS!';
                 console.log("Saved to Google Sheets successfully.");
            } else {
                throw new Error(result.error || 'Unknown error');
            }
        } catch (err) {
            console.error('gsSaveAll error:', err);
            alert('Lỗi khi lưu lên Google Sheets: ' + err.message);
            label.textContent = 'Lưu GS lỗi!';
        } finally {
            setTimeout(() => {
                btnSave.disabled = false;
                label.textContent = 'Lưu';
            }, 2000);
        }
    };
    
    async function gsLoadAll() {
        if (!USE_REMOTE) return false;
        try {
            const resp = await fetch(`${GS_URL}?action=readAll&cachebust=${new Date().getTime()}`);
            const j = await resp.json();
            if (j.ok && j.data) {
                const remote = j.data;
                if (remote.batches && remote.batches.length > 0) batches = remote.batches;
                if (remote.customers && remote.customers.length > 0) {
                    const localCustomerNames = new Set(customers.map(c => c.name.toLowerCase()));
                    const newCustomersFromRemote = remote.customers.filter(rc => !localCustomerNames.has(rc.name.toLowerCase()));
                    customers = [...customers, ...newCustomersFromRemote];
                }
                currentBatchId = remote.currentBatchId || batches[0]?.id || currentBatchId;
                persistAll();
                renderAll();
                return true;
            }
            return false;
        } catch (err) { console.error('gsLoadAll error', err); return false; }
    }
    
    // ---------- INITIALIZATION ----------
    const attachHandlers = () => {
        $('#btnNewBatch').addEventListener('click', () => createNewBatch(false));
        $('#btnDeleteBatch').addEventListener('click', deleteCurrentBatch);
        $('#selBatches').addEventListener('change', (e) => { currentBatchId = e.target.value; persistAll(); renderAll(); });
        $('#btnSave').addEventListener('click', saveAll);
        $('#btnExportExcel').addEventListener('click', exportCurrentBatchToExcel);
        $('#btnAddProd').addEventListener('click', addProductFromForm);
        $('#tblProducts').addEventListener('click', handleProductTableClick);
        $('#btnAddOrder').addEventListener('click', addOrUpdateOrderFromForm);
        $('#btnAddItem').addEventListener('click', () => addItemRow());
        $('#itemsContainer').addEventListener('click', (e) => {
            if (e.target.closest('.btn-del-item')) { e.target.closest('.row').remove(); updateOrderTotal(); }
        });
        $('#itemsContainer').addEventListener('input', (e) => { if (e.target.matches('input, select')) updateOrderTotal(); });
        $('#tblOrders').addEventListener('click', handleOrderTableClick);
        $('#btnOrderNavPrev').addEventListener('click', () => navigateOrder(-1));
        $('#btnOrderNavNext').addEventListener('click', () => navigateOrder(1));
        $('#toggleCustomers').addEventListener('click', () => {
            $('#customersContainer').classList.toggle('hidden');
            const icon = $('#toggleCustomers').querySelector('i');
            icon.setAttribute('data-feather', $('#customersContainer').classList.contains('hidden') ? 'eye-off' : 'eye');
            ensureIcons();
        });
        $('#uploadCustomers').addEventListener('change', (e) => { if (e.target.files[0]) handleUploadCustomers(e.target.files[0]); e.target.value = ''; });
        $('#customerSearch').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filtered = customers.filter(c => c.name.toLowerCase().includes(query) || (c.phone||'').includes(query));
            renderCustomersPanel(filtered);
        });
        const customerInput = $('#orderCustomer');
        customerInput.addEventListener('input', showCustomerSuggestions);
        customerInput.addEventListener('blur', () => setTimeout(() => $('#customer-suggestions').classList.add('hidden'), 150));
    };

    const init = () => {
        loadLocal();
        if (batches.length === 0) {
            createNewBatch(true);
        }
        attachHandlers();
        renderAll();
        if (USE_REMOTE) {
            gsLoadAll().then(ok => console.log(ok ? "Remote data loaded." : "Could not load remote data."));
        }
    };

    document.addEventListener('DOMContentLoaded', init);
  </script>
