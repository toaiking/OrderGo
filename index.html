<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>OrderGo - Load mã rõ ràng</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"/>
  <style>
    :root{
      --bg:#eaf6f3; --card:#fff; --accent:#2f9e8f; --muted:#6b7280; --danger:#e55353;
      --radius:12px; font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
    }
    body{background:var(--bg);padding:18px}
    .wrap{max-width:1100px;margin:0 auto}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 8px 30px rgba(23,43,77,0.06);padding:16px;margin-bottom:14px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between}
    h1{font-size:18px;margin:0}
    .controls{display:flex;gap:8px;align-items:center}

    .btn{display:inline-flex;gap:8px;align-items:center;justify-content:center;background:var(--accent);color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    .btn.small{padding:6px 8px;font-size:13px}
    .btn.secondary{background:transparent;color:var(--accent);border:1px solid rgba(47,158,143,0.12)}
    .btn.ghost{background:transparent;color:var(--muted);border:1px solid rgba(0,0,0,0.04)}
    .btn.load{background:#2b7be9;color:white} /* make load button visible */

    input[type=text],input[type=number],select{padding:8px;border-radius:8px;border:1px solid #e6eef0;width:100%;box-sizing:border-box}
    .row{display:flex;gap:12px}
    .col{flex:1}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #f1f6f5;text-align:left;vertical-align:top}
    th{color:var(--muted);font-weight:600}
    .muted{color:var(--muted)}
    .badge{background:#eef9f7;color:var(--accent);padding:6px 10px;border-radius:999px}
    .customers-panel{border-radius:8px;border:1px solid #e6eef0;padding:8px;max-height:220px;overflow:auto;background:#fff}
    .notice{font-size:13px;color:#334155}
    .wrap-text{white-space:pre-wrap;word-break:break-word}
    @media (max-width:900px){ .row{flex-direction:column} .controls{flex-direction:column;align-items:flex-end} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <div>
          <h1>OrderGo — Quản lý đơn hàng</h1>
          <div class="notice">Nếu bạn không có mã, bấm <strong>Load mã</strong> để nạp từ Google Sheets (nếu đã cấu hình GS_URL).</div>
        </div>
        <div class="controls">
          <button id="btnNewBatch" class="btn small">Tạo mã</button>
          <select id="selBatches" style="min-width:220px"></select>
          <!-- Load mã button rõ ràng -->
          <button id="btnLoadBatches" class="btn load small" title="Load tất cả mã từ Google Sheets">Load mã</button>
          <button id="btnSave" class="btn small">Lưu</button>
        </div>
      </header>
    </div>

    <div class="card">
      <h3>Bảng danh sách hàng hóa</h3>
      <div style="margin-bottom:10px" class="row">
        <div style="width:260px"><input id="prodName" type="text" placeholder="Tên hàng"/></div>
        <div style="width:120px"><input id="prodIn" type="number" placeholder="Nhập" min="0"/></div>
        <div style="width:160px"><input id="prodPrice" type="number" placeholder="Giá bán (VND)" min="0"/></div>
        <div><button id="btnAddProd" class="btn small">Thêm</button></div>
      </div>
      <table id="tblProducts">
        <thead><tr><th>Tên</th><th>Nhập</th><th>Đã bán</th><th>Tồn</th><th>Giá</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h3>Bảng nhập đơn</h3>
      <div class="row">
        <div class="col"><input id="orderCustomer" list="customersDatalist" type="text" placeholder="Khách hàng"/></div>
        <div class="col"><input id="orderAddress" type="text" placeholder="Địa chỉ"/></div>
        <div style="width:160px"><input id="orderPhone" type="text" placeholder="SĐT"/></div>
      </div>
      <datalist id="customersDatalist"></datalist>
      <div style="margin-top:8px" id="itemsContainer"></div>
      <div style="margin-top:8px" class="row">
        <div style="width:150px"><button id="btnAddItem" class="btn small">Thêm hàng</button></div>
        <div style="margin-left:auto"><div class="muted">Tổng tiền: <span id="orderTotal" class="badge">0</span></div></div>
      </div>
      <div style="margin-top:10px"><button id="btnAddOrder" class="btn">Thêm đơn</button></div>
    </div>

    <div class="card">
      <h3>Danh sách đơn</h3>
      <table id="tblOrders">
        <thead><tr><th>STT</th><th>Khách</th><th>Địa chỉ / SĐT</th><th>Danh sách</th><th>Tổng tiền</th><th>Action</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><td colspan="4" class="muted" style="text-align:right">Tổng cả mã:</td><td id="grandTotal">0</td><td></td></tr></tfoot>
      </table>
    </div>

    <div class="card">
      <h3>Khách hàng (gợi ý)</h3>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <input id="customerSearch" type="text" placeholder="Tìm khách (tên hoặc SĐT)" style="flex:1"/>
        <input id="uploadCustomers" type="file" accept=".xlsx,.csv"/>
      </div>
      <div id="customersPanel" class="customers-panel"></div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    // CONFIG: paste your Apps Script web app URL here if needed
    const GS_URL = ''; // e.g. 'https://script.google.com/macros/s/.../exec'
    const USE_REMOTE = GS_URL && GS_URL.includes('script.google.com');

    // utils
    const $ = id => document.getElementById(id);
    function fmtCurrency(v){ return Intl.NumberFormat('vi-VN').format(Number(v||0)); }
    function uid(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2,9); }
    function lc(s){ return String(s||'').trim().toLowerCase(); }

    // state
    let batches = []; // {id,name,products:[],orders:[]}
    let customers = []; // {name,address,phone}
    let currentBatchId = null;
    const LS_KEY = 'ordergo_v_loadbutton_v1';

    // persistence
    function persistAll(){ localStorage.setItem(LS_KEY, JSON.stringify({ batches, customers, currentBatchId })); }
    function loadLocal(){ const raw = localStorage.getItem(LS_KEY); if(!raw) return; try{ const d = JSON.parse(raw); batches = d.batches||[]; customers = d.customers||[]; currentBatchId = d.currentBatchId || (batches[0] && batches[0].id) || null; }catch(e){ console.warn(e); } }

    // render functions
    function renderBatchList(){
      const sel = $('selBatches'); sel.innerHTML = '';
      if(!batches || batches.length===0){
        const opt = document.createElement('option'); opt.value=''; opt.textContent='(Chưa có mã đơn)'; sel.appendChild(opt); return;
      }
      batches.forEach(b=>{
        const opt = document.createElement('option'); opt.value=b.id; opt.textContent=b.name;
        if(b.id === currentBatchId) opt.selected = true;
        sel.appendChild(opt);
      });
    }

    function getCurrentBatch(){ return batches.find(b=>b.id===currentBatchId); }

    function renderProducts(){
      const tbody = $('tblProducts').querySelector('tbody'); tbody.innerHTML='';
      const b = getCurrentBatch();
      if(!b){
        const tr = document.createElement('tr'); tr.innerHTML = `<td colspan="6" class="muted">Không có mã đơn. Hãy tạo mã mới hoặc bấm "Load mã".</td>`; tbody.appendChild(tr); return;
      }
      (b.products||[]).forEach((p,idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${p.name}</td><td>${p.in}</td><td>${p.sold||0}</td><td>${p.remain||0}</td><td>${fmtCurrency(p.price)}</td><td><button data-idx="${idx}" data-action="edit" class="btn small">Sửa</button> <button data-idx="${idx}" data-action="del" class="btn small ghost">Xóa</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function renderOrders(){
      const tbody = $('tblOrders').querySelector('tbody'); tbody.innerHTML='';
      const b = getCurrentBatch();
      if(!b){
        const tr = document.createElement('tr'); tr.innerHTML = `<td colspan="6" class="muted">Không có mã đơn. Hãy tạo mã mới hoặc bấm "Load mã".</td>`; tbody.appendChild(tr); $('grandTotal').textContent = fmtCurrency(0); return;
      }
      let grand = 0;
      (b.orders||[]).forEach((o,idx)=>{
        const itemsStr = (Array.isArray(o.items) ? o.items.map(it=>`${it.name} x${it.qty}`).join('<br/>') : o.items||'');
        grand += Number(o.total||0);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${idx+1}</td><td>${o.customer}</td><td class="wrap-text">${o.address} / ${o.phone}</td><td class="wrap-text">${itemsStr}</td><td>${fmtCurrency(o.total)}</td><td><button data-idx="${idx}" data-action="edit-order" class="btn small">Sửa</button> <button data-idx="${idx}" data-action="del-order" class="btn small ghost">Xóa</button></td>`;
        tbody.appendChild(tr);
      });
      $('grandTotal').textContent = fmtCurrency(grand);
    }

    function renderCustomersPanel(){
      const panel = $('customersPanel'); panel.innerHTML='';
      if(!customers || customers.length===0){ panel.innerHTML = '<div class="muted">(Chưa có khách hàng)</div>'; updateCustomersDatalist(); return; }
      customers.forEach((c,i)=>{
        const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='6px 0';
        row.innerHTML = `<div><strong>${c.name}</strong><div class="muted">${c.address} • ${c.phone}</div></div>`;
        const btns = document.createElement('div'); const btnChoose = document.createElement('button'); btnChoose.className='btn small ghost'; btnChoose.textContent='Chọn'; btnChoose.addEventListener('click', ()=>{ $('orderCustomer').value = c.name; $('orderAddress').value = c.address; $('orderPhone').value = c.phone; });
        const btnDel = document.createElement('button'); btnDel.className='btn small'; btnDel.style.marginLeft='8px'; btnDel.textContent='Xóa'; btnDel.addEventListener('click', ()=>{ if(confirm('Xóa khách?')){ customers.splice(i,1); persistAll(); renderCustomersPanel(); updateCustomersDatalist(); } });
        btns.appendChild(btnChoose); btns.appendChild(btnDel); row.appendChild(btns); panel.appendChild(row);
      });
      updateCustomersDatalist();
    }

    function updateCustomersDatalist(){
      const dl = $('customersDatalist'); if(!dl) return; dl.innerHTML='';
      (customers||[]).forEach(c=>{ const o=document.createElement('option'); o.value = c.name; dl.appendChild(o); });
    }

    // item rows
    function addItemRow(prefName='', prefQty=1){
      const row = document.createElement('div'); row.className='row'; row.style.marginTop='8px';
      const sel = document.createElement('select'); sel.className='item-select'; sel.style.width='40%';
      const spacer = document.createElement('div'); spacer.style.width='12px';
      const qty = document.createElement('input'); qty.type='number'; qty.min=0; qty.value = prefQty; qty.style.width='120px';
      const btnDel = document.createElement('button'); btnDel.className='btn small ghost'; btnDel.type='button'; btnDel.textContent='Xóa';
      row.appendChild(sel); row.appendChild(spacer); row.appendChild(qty); row.appendChild(btnDel);
      $('itemsContainer').appendChild(row);
      btnDel.addEventListener('click', ()=>{ row.remove(); updateOrderTotal(); });
      sel.addEventListener('change', updateOrderTotal);
      qty.addEventListener('input', updateOrderTotal);
      refreshItemSelectOptions();
      if(prefName) sel.value = prefName;
      return row;
    }

    function refreshItemSelectOptions(){
      const b = getCurrentBatch();
      const names = b ? (b.products||[]).map(p=>p.name) : [];
      document.querySelectorAll('.item-select').forEach(sel=>{
        const prev = sel.value;
        sel.innerHTML = '';
        const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent='-- Chọn hàng --'; sel.appendChild(opt0);
        if(names.length===0){ const o=document.createElement('option'); o.value=''; o.textContent='(Chưa có hàng)'; sel.appendChild(o); }
        names.forEach(n=>{ const o=document.createElement('option'); o.value = n; o.textContent = n; if(n===prev) o.selected=true; sel.appendChild(o); });
      });
    }

    function updateOrderTotal(){
      let total = 0;
      document.querySelectorAll('#itemsContainer .row').forEach(row=>{
        const name = row.querySelector('select').value;
        const qty = Number(row.querySelector('input[type=number]').value||0);
        const prod = getCurrentBatch() ? (getCurrentBatch().products||[]).find(p=>p.name===name) : null;
        if(prod) total += Number(prod.price||0) * qty;
      });
      $('orderTotal').textContent = fmtCurrency(total);
      return total;
    }

    // actions
    function createNewBatch(){
      const name = prompt('Tên mã đơn (tùy chọn, có thể để trống):','');
      const id = uid('batch');
      const finalName = name ? sanitizeName(name) : id;
      batches.unshift({ id, name: finalName, products: [], orders: [] });
      currentBatchId = id;
      persistAll(); renderAll();
      alert('Đã tạo mã: ' + finalName);
    }

    function sanitizeName(name){ return String(name||'').trim().replace(/[^\w\-\s]/g,'_').slice(0,90); }

    function addProduct(){
      const name = $('prodName').value.trim(); if(!name){ alert('Nhập tên hàng'); return; }
      const pin = Number($('prodIn').value||0); const price = Number($('prodPrice').value||0);
      const b = getCurrentBatch(); if(!b){ alert('Chọn hoặc tạo mã trước'); return; }
      b.products.push({ name, in: pin, sold:0, remain: pin, price });
      $('prodName').value=''; $('prodIn').value=''; $('prodPrice').value='';
      persistAll(); renderProducts(); refreshItemSelectOptions();
    }

    function addOrder(){
      const b = getCurrentBatch(); if(!b){ alert('Chọn mã trước'); return; }
      const customer = $('orderCustomer').value.trim(); if(!customer){ alert('Nhập khách'); return; }
      const address = $('orderAddress').value.trim(); const phone = $('orderPhone').value.trim();
      const items = [];
      document.querySelectorAll('#itemsContainer .row').forEach(row=>{
        const name = row.querySelector('select').value; const qty = Number(row.querySelector('input[type=number]').value||0);
        if(name && qty>0) items.push({ name, qty });
      });
      if(items.length===0){ alert('Phải có ít nhất 1 mặt hàng'); return; }
      const total = updateOrderTotal();
      const order = { customer, address, phone, items, total, created: new Date().toISOString() };
      b.orders.push(order);
      items.forEach(it=>{ const p = b.products.find(pp=>pp.name===it.name); if(p){ p.sold = (p.sold||0)+it.qty; p.remain = (p.in||0)-p.sold; if(p.remain<0) p.remain=0; } });
      // update customers
      const idx = customers.findIndex(c => lc(c.name) === lc(customer));
      if(idx === -1){ customers.unshift({ name: customer, address, phone }); } else { customers[idx].address = address; customers[idx].phone = phone; }
      // reset form
      $('orderCustomer').value=''; $('orderAddress').value=''; $('orderPhone').value='';
      document.getElementById('itemsContainer').innerHTML=''; addItemRow('',1); addItemRow('',1);
      persistAll(); renderAll();
    }

    // export/load helpers
    function exportLocalJSON(){ const data = { batches, customers, currentBatchId }; const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'ordergo_local.json'; a.click(); }

    // GS functions (POST as form-encoded to avoid preflight)
    async function gsSaveAll(){
      if(!USE_REMOTE){ alert('GS_URL chưa cấu hình'); return false; }
      try{
        const params = new URLSearchParams();
        params.append('action','saveAll');
        params.append('data', JSON.stringify({ batches, customers, currentBatchId }));
        const resp = await fetch(GS_URL, { method:'POST', body: params });
        const text = await resp.text();
        try{ const j = JSON.parse(text); if(j.ok){ alert('Đã lưu lên Google Sheets'); return true; } else { console.warn(j); alert('Lưu thất bại: '+(j.error||text)); return false; } } catch(e){ console.warn('Non-JSON', text); alert('Server trả về dữ liệu không hợp lệ'); return false; }
      } catch(err){ console.error(err); alert('Lỗi khi lưu lên server'); return false; }
    }

    async function gsLoadAll(){
      if(!USE_REMOTE){ alert('GS_URL chưa cấu hình'); return false; }
      try{
        const url = GS_URL + (GS_URL.includes('?') ? '&' : '?') + 'action=readAll';
        const resp = await fetch(url); if(!resp.ok){ console.warn('HTTP', resp.status); return false; }
        const j = await resp.json();
        if(j && j.ok && j.data){
          const remote = j.data;
          // remote batches overwrite local
          batches = (remote.batches || []).map(rb => ({ id: rb.id || rb.name, name: rb.name, products: rb.products || [], orders: rb.orders || [] }));
          // merge customers with remote priority
          const map = {};
          (remote.customers||[]).concat(customers||[]).forEach(c=>{ const k = lc(c.name||''); if(!map[k]) map[k] = { name:c.name||'', address:c.address||'', phone:c.phone||'' }; else { if(c.address) map[k].address = c.address; if(c.phone) map[k].phone = c.phone; } });
          customers = Object.keys(map).map(k=>map[k]);
          currentBatchId = remote.currentBatchId || (batches[0] && batches[0].id) || null;
          persistAll(); renderAll();
          return true;
        }
        return false;
      } catch(err){
        console.error('gsLoadAll', err); return false;
      }
    }

    // file import customers
    function handleUploadCustomers(file){
      const reader = new FileReader();
      reader.onload = function(e){
        const data = e.target.result;
        let wb = null;
        try{ wb = XLSX.read(data, { type:'binary' }); } catch(ex){ try{ wb = XLSX.read(data, { type:'string' }); } catch(ex2){ alert('Không đọc được file'); return; } }
        const first = wb.SheetNames[0];
        const ws = wb.Sheets[first];
        const arr = XLSX.utils.sheet_to_json(ws, { header:1 });
        arr.slice(1).forEach(r=>{ const name = r[0]||''; const addr = r[1]||''; const phone = r[2]||''; if(name){ const idx = customers.findIndex(c=>lc(c.name)===lc(name)); if(idx===-1) customers.unshift({ name, address:addr, phone }); else { customers[idx].address = addr; customers[idx].phone = phone; } }});
        persistAll(); renderCustomersPanel(); alert('Import hoàn tất');
      };
      reader.readAsBinaryString(file);
    }

    // delegated handlers for product/order table actions
    function attachTableDelegation(){
      const pbody = document.querySelector('#tblProducts tbody');
      if(pbody && !pbody._d){ pbody.addEventListener('click', e=>{ const btn = e.target.closest('button[data-action]'); if(!btn) return; const act = btn.dataset.action; const idx = Number(btn.dataset.idx); const b = getCurrentBatch(); if(!b) return; if(act==='del'){ if(confirm('Xóa?')){ b.products.splice(idx,1); persistAll(); renderProducts(); refreshItemSelectOptions(); } } else if(act==='edit'){ const p = b.products[idx]; const newName = prompt('Tên', p.name); if(newName!==null){ p.name=newName; p.in = Number(prompt('Nhập', p.in)||p.in); p.price = Number(prompt('Giá', p.price)||p.price); p.remain = p.in - (p.sold||0); persistAll(); renderProducts(); } } }); pbody._d=true; }
      const obody = document.querySelector('#tblOrders tbody');
      if(obody && !obody._d){ obody.addEventListener('click', e=>{ const btn = e.target.closest('button[data-action]'); if(!btn) return; const act = btn.dataset.action; const idx = Number(btn.dataset.idx); const b = getCurrentBatch(); if(!b) return; if(act==='del-order'){ if(confirm('Xóa đơn?')){ b.orders.splice(idx,1); persistAll(); renderOrders(); renderProducts(); } } else if(act==='edit-order'){ const o = b.orders[idx]; if(!o) return; $('orderCustomer').value = o.customer; $('orderAddress').value = o.address; $('orderPhone').value = o.phone; document.getElementById('itemsContainer').innerHTML=''; (o.items||[]).forEach(it=>addItemRow(it.name, it.qty)); updateOrderTotal(); b.orders.splice(idx,1); persistAll(); renderOrders(); } }); obody._d=true; }
    }

    // attach handlers (including Load mã)
    function attachHandlers(){
      $('btnNewBatch').addEventListener('click', createNewBatch);
      $('selBatches').addEventListener('change', e=>{ currentBatchId = e.target.value; persistAll(); renderAll(); });
      $('btnAddProd').addEventListener('click', addProduct);
      $('btnAddItem').addEventListener('click', ()=>addItemRow('','',1));
      $('btnAddOrder').addEventListener('click', addOrder);
      $('btnSave').addEventListener('click', ()=>{ persistAll(); if(USE_REMOTE) gsSaveAll(); alert('Đã lưu local (và bắt đầu gửi lên remote nếu cấu hình)'); });
      $('uploadCustomers').addEventListener('change', e=>{ const f = e.target.files[0]; if(f) handleUploadCustomers(f); });
      $('customerSearch').addEventListener('input', e=>{ const q = e.target.value.toLowerCase(); const found = customers.filter(c=> (c.name||'').toLowerCase().includes(q) || (c.phone||'').toLowerCase().includes(q)); if(found.length){ $('orderCustomer').value = found[0].name; $('orderAddress').value = found[0].address; $('orderPhone').value = found[0].phone; } });

      // Load mã button
      const loadBtn = $('btnLoadBatches');
      if(loadBtn){
        loadBtn.addEventListener('click', async ()=>{
          if(!USE_REMOTE){ alert('GS_URL chưa cấu hình trong file.'); return; }
          loadBtn.textContent = 'Đang tải...'; loadBtn.disabled = true;
          try{
            const ok = await gsLoadAll();
            if(ok){ alert('Đã load các mã từ Google Sheets vào local'); }
            else { alert('Không tìm thấy dữ liệu trên Google Sheets hoặc lỗi'); }
          } catch(err){ console.error(err); alert('Lỗi khi load. Xem console.'); }
          finally{ loadBtn.disabled = false; loadBtn.textContent = 'Load mã'; }
        });
      }

      attachTableDelegation();
    }

    function renderAll(){ renderBatchList(); renderProducts(); renderOrders(); renderCustomersPanel(); attachTableDelegation(); }

    // init
    (function init(){
      loadLocal();
      // Do not auto-create batch on start. UI shows 'Chưa có mã' and user can click Load mã or Create mã.
      // Prepare two empty item rows for convenience
      addItemRow('','',1); addItemRow('','',1);
      attachHandlers();
      renderAll();
      feather.replace(); // render icons
    })();

  </script>
</body>
</html>
